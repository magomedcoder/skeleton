syntax = "proto3";

package account;

import "chat.proto";
import "common.proto";
import "project.proto";

option go_package = "github.com/magomedcoder/legion/api/pb/accountpb;accountpb";

service AccountService {
  rpc ChangePassword(ChangePasswordRequest) returns (ChangePasswordResponse);

  rpc GetDevices(GetDevicesRequest) returns (GetDevicesResponse);

  rpc RevokeDevice(RevokeDeviceRequest) returns (RevokeDeviceResponse);

  rpc GetUpdates(stream UpdateRequest) returns (stream UpdateResponse);
}

message UpdateState {
  int64 pts = 1;
  int64 date = 2;
}

message UpdateSystemPingEvent {}

message UpdateSystemPongEvent {}

message UpdateSystemAckEvent {
  string sid = 1;
}

message UpdateSystemPingIntervalEvent {
  string ping_interval = 1;
  string ping_timeout = 2;
}

message UpdateSystemEvent {
  string event = 1;
  string sid = 2;
  bool is_ack = 3;
  int32 retry = 4;
}

message UpdateSystem {
  oneof update_system_type {
    UpdateSystemPingIntervalEvent system_ping_interval_event = 1;
    UpdateSystemPingEvent system_ping_event = 2;
    UpdateSystemPongEvent system_pong_event = 3;
    UpdateSystemAckEvent system_ack_event = 4;
    UpdateSystemEvent system_event = 5;
  }
}

message UpdateUserStatus {
  int64 user_id = 1;
  bool status  = 2;
}

message UpdateNewMessage {
  chat.Message message = 1;
}

message UpdateMessageDeleted {
  common.Peer peer = 1;
  common.Peer from_peer = 2;
  repeated int64 message_ids = 3;
}

message UpdateNewTask {
  string project_id = 1;
  project.Task task = 2;
}

message UpdateTaskChanged {
  string project_id = 1;
  project.Task task = 2;
}

message Update {
  oneof update_type {
    UpdateUserStatus user_status = 1;
    UpdateNewMessage new_message = 2;
    UpdateNewTask new_task = 3;
    UpdateTaskChanged task_changed = 4;
    UpdateMessageDeleted message_deleted = 5;
  }
}

message ChangePasswordRequest {
  string old_password = 1;
  string new_password = 2;
  string current_refresh_token = 3;
}

message ChangePasswordResponse {
  bool success = 1;
}

message GetDevicesRequest {}

message Device {
  int32 id = 1;
  int64 created_at_seconds = 2;
}

message GetDevicesResponse {
  repeated Device devices = 1;
}

message RevokeDeviceRequest {
  int32 device_id = 1;
}

message RevokeDeviceResponse {
  bool success = 1;
}

message UpdateRequest {
  UpdateState state = 1;
  oneof update {
    UpdateSystemPingEvent system_ping_event = 2;
    UpdateSystemPongEvent system_pong_event = 3;
  }
}

message UpdateResponse {
  UpdateState state = 1;
  UpdateSystem update_system = 2;
  repeated Update updates = 3;
}