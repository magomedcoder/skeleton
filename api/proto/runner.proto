syntax = "proto3";

package runner;

import "common.proto";
import "aichat.proto";

option go_package = "github.com/magomedcoder/legion/api/pb/runnerpb;runnerpb";

service RunnerService {
  rpc Ping(legion.Empty) returns (PingResponse);

  rpc GetModels(legion.Empty) returns (GetModelsResponse);

  rpc Generate(GenerateRequest) returns (stream GenerateResponse);

  rpc Register(RegisterRunnerRequest) returns (legion.Empty);

  rpc Unregister(UnregisterRunnerRequest) returns (legion.Empty);

  rpc GetGpuInfo(legion.Empty) returns (GetGpuInfoResponse);

  rpc GetServerInfo(legion.Empty) returns (ServerInfo);
}

service RunnerAdminService {
  rpc GetRunners(legion.Empty) returns (GetRunnersResponse) {
    option (legion.method_conf) = {
      role: ROLE_ADMIN
    };
  }

  rpc SetRunnerEnabled(SetRunnerEnabledRequest) returns (legion.Empty) {
    option (legion.method_conf) = {
      role: ROLE_ADMIN
    };
  }

  rpc GetRunnersStatus(legion.Empty) returns (GetRunnersStatusResponse);
}

message PingResponse {
  bool ok = 1;
}

message GetModelsResponse {
  repeated string models = 1;
}

message GenerateRequest {
  string session_id = 1;
  repeated chat.ChatMessage messages = 2;
  string model = 3;
}

message GenerateResponse {
  string content = 1;
  bool done = 2;
}

message RegisterRunnerRequest {
  string address = 1;
}

message UnregisterRunnerRequest {
  string address = 1;
}

message GpuInfo {
  string name = 1;
  int32 temperature_c = 2;
  uint64 memory_total_mb = 3;
  uint64 memory_used_mb = 4;
  uint32 utilization_percent = 5;
}

message GetGpuInfoResponse {
  repeated GpuInfo gpus = 1;
}

message ServerInfo {
  string hostname = 1;
  string os = 2;
  string arch = 3;
  int32 cpu_cores = 4;
  uint64 memory_total_mb = 5;
  repeated string models = 6;
}

message RunnerInfo {
  string address = 1;
  bool enabled = 2;
  bool connected = 3;
  repeated GpuInfo gpus = 4;
  ServerInfo server_info = 5;
}

message GetRunnersResponse {
  repeated RunnerInfo runners = 1;
}

message SetRunnerEnabledRequest {
  string address = 1;
  bool enabled = 2;
}

message GetRunnersStatusResponse {
  bool has_active_runners = 1;
}
